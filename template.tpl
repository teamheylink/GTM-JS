___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Heylink",
  "categories": [
    "AFFILIATE_MARKETING",
    "ADVERTISING"
  ],
  "brand": {
    "id": "Heylink",
    "displayName": "Heylink",
    "thumbnail": "data:image/jpeg;base64,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\u003d\u003d"
  },
  "description": "",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "type",
    "displayName": "Type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "page_view",
        "displayValue": "Page_view"
      },
      {
        "value": "purchase",
        "displayValue": "Purchase"
      }
    ],
    "simpleValueType": true,
    "help": "You need to set up both a page_view and a purchase event"
  },
  {
    "type": "TEXT",
    "name": "orderTax",
    "displayName": "Tax",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ],
    "help": "Tax (vat) of the total order value"
  },
  {
    "type": "TEXT",
    "name": "orderId",
    "displayName": "Order id",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ],
    "help": "Order id of the purchase"
  },
  {
    "type": "TEXT",
    "name": "orderTotal",
    "displayName": "Total value",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ],
    "help": "Total order value including tax"
  },
  {
    "type": "TEXT",
    "name": "orderCurrencyCode",
    "displayName": "Currency",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ],
    "help": "Currency code (DKK, NOK, EUR, USD etc.)",
    "defaultValue": "DKK"
  },
  {
    "type": "TEXT",
    "name": "orderCouponCode",
    "displayName": "Coupon",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ],
    "help": "Coupon code used on the purchase"
  },
  {
    "type": "TEXT",
    "name": "taxRate",
    "displayName": "VAT rate",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ],
    "defaultValue": 0.25
  },
  {
    "type": "LABEL",
    "name": "Shipping",
    "displayName": "Shipping settings:",
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "RADIO",
    "name": "shippingVat",
    "displayName": "",
    "radioItems": [
      {
        "value": "inclVat",
        "displayValue": "Shipping is tracked including VAT"
      },
      {
        "value": "exVat",
        "displayValue": "Shipping is tracked excluding VAT"
      }
    ],
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "orderShipping",
    "displayName": "Shipping",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ],
    "help": "Shipping value of the purchase in the tracking"
  },
  {
    "type": "TEXT",
    "name": "cookieDays",
    "displayName": "Days to keep Cookie",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "page_view",
        "type": "EQUALS"
      }
    ],
    "defaultValue": 40,
    "valueValidators": [
      {
        "type": "POSITIVE_NUMBER"
      }
    ]
  },
  {
    "type": "LABEL",
    "name": "product data",
    "displayName": "Product data:",
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "includeProductData",
    "checkboxText": "Include product data",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "items",
    "displayName": "Google Analytics 4 Items",
    "macrosInSelect": true,
    "selectItems": [],
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "includeProductData",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "help": "Google Analytics 4 items standard"
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "simpleTable1",
    "displayName": "",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "brand",
        "name": "brand",
        "type": "TEXT"
      },
      {
        "defaultValue": "",
        "displayName": "produkt type",
        "name": "type",
        "type": "TEXT"
      },
      {
        "defaultValue": "",
        "displayName": "Affiliate sats",
        "name": "gruppe",
        "type": "TEXT"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

//# HeyLink Client Side Template
//# Last updated: 11Nov22@1530
const parseUrl = require('parseUrl');
const getUrl = require('getUrl');
const logToConsole = require('logToConsole');
const setCookie = require('setCookie');
const getCookieValues = require('getCookieValues');
const JSON = require('JSON');
const encodeUri = require('encodeUri');
const queryPermission = require('queryPermission');
const sendPixel = require('sendPixel');
const makeNumber = require('makeNumber');

//--------------------------------------

var expirationTime = data.cookieDays * 24 * 60 * 60;
const affiliateCookieName = 'hltid';
const debugOn = false;

// Customer end-point url to send server-side data to
const apiUrl = 'https://heylinkapi.com/connect/v1/callbacks/advertisers';

//--------------------------------------
// set cookie 
if(getEvetName() == 'page_view') {
    debugLogger('[page_view] initiated');
  
    const hltid = parseUrl(getUrl()).searchParams.hltid;
    
    if (hltid)
      setCookie(affiliateCookieName, hltid, {'max-age': expirationTime, sameSite: 'lax',  httpOnly: true, domain: 'auto', path: '/', secure: true});
   
    debugLogger('[page_view] done');
}

// track conversion
if(getEvetName() == 'purchase') {
      var affiliateCookieId = getCookieValues(affiliateCookieName)[0];
      
	   if (affiliateCookieId) {
	     debugLogger('[purchase] initiated');
         debugLogger('[purchase] received hltid: ' + affiliateCookieId);
		 debugLogger('[purchase] received data_items: ');
         debugLogger('[purchase] All GTM received data' + JSON.stringify(data));
         debugLogger('[purchase] items:' + data.items);

         
         // const items = JSON.parse(data.items);
         const items = data.items;
         
          let orderItemsQuery = '';
     
     for (var i = 0; i < items.length; i++) {
       var p = items[i];
       orderItemsQuery += '&orderItems['+i+'][itemId]=' + p.item_id;
       orderItemsQuery += '&orderItems['+i+'][itemName]=' + p.item_name;
       orderItemsQuery += '&orderItems['+i+'][itemPrice]=' + p.price;
       orderItemsQuery += '&orderItems['+i+'][itemQuantity]=' + p.quantity;
       orderItemsQuery += '&orderItems['+i+'][itemCategoryName]=' + p.item_category;
     }
         
         debugLogger('[purchase] Will try to construct payload now');
         
         // adjust shipping for payload
         var orderShippingSubTotal;
         var orderShipping;
         if (data.shippingVat == "inclVat")  {
           orderShippingSubTotal = data.orderShipping  / (1 + makeNumber(data.taxRate));
           orderShipping = data.orderShipping;
         }
         else {
           orderShippingSubTotal = data.orderShipping;    
         }
         
         // payload
		 const payload = {
            hltid: affiliateCookieId,
            orderSubTotal: (makeNumber(data.orderTotal) - makeNumber(data.orderTax) - orderShippingSubTotal),
            orderId: data.orderId,
            orderShipping: orderShipping,
            orderShippingSubTotal: orderShippingSubTotal,
            orderTax: data.orderTax,
            orderTaxRate: data.taxRate,
            orderTotal: data.orderTotal, 
            orderCurrencyCode: data.orderCurrencyCode,
            orderCouponCode: data.orderCouponCode,
            //orderItems: order_items //TODO: Maybe To be implemented later, when the end-point starts supporting it
		 };
         

         
           debugLogger('[purchase] payload constructed');
		   debugLogger('[purchase] payload: ' + JSON.stringify(payload) );
		
           // delete cookie
		   setCookie(affiliateCookieName, '', {'max-age': 0, sameSite: 'lax',  httpOnly: true, domain: 'auto', path: '/', secure: true});
		
           // send data to customer end-point
           let endPointParams = '/?orderId=' + payload.orderId;
           endPointParams += '&orderShipping=' + payload.orderShipping;
           endPointParams += '&orderShippingSubTotal=' + payload.orderShippingSubTotal;
           endPointParams += '&orderTax=' + payload.orderTax;
           endPointParams += '&orderTaxRate=' + payload.orderTaxRate;
           endPointParams += '&orderTotal=' + payload.orderTotal;
           endPointParams += '&orderSubTotal=' + payload.orderSubTotal;
           endPointParams += '&orderCurrencyCode=' + payload.orderCurrencyCode;
           endPointParams += '&orderCouponCode=' + payload.orderCouponCode;
           endPointParams += '&hltid=' + payload.hltid;
           
           
            
           let endPointUrl = apiUrl + encodeUri(endPointParams + orderItemsQuery);
         
           debugLogger('[purchase] Will try to send data to customer end-point now on url:');
           debugLogger('[purchase] ' + endPointUrl);
         
         if (queryPermission('send_pixel', endPointUrl)) 
             sendPixel(endPointUrl, onSuccess, onFailure);
         else {
             debugLogger('[purchase] Does not have permission to send');
             data.gtmOnFailure();
         }
                 
            debugLogger('[purchase] done');
	  }
	}

function getEvetName() {
  return data.type;
}

function onSuccess() {
  debugLogger('Send: Success');
}

function onFailure() {
  debugLogger('Send: Failure');
}

function debugLogger(msg) {
  if(debugOn) logToConsole('[GTM - Client Template] ' + msg);
}

data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryKeys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "hltid"
              }
            ]
          }
        },
        {
          "key": "query",
          "value": {
            "type": 8,
            "boolean": true
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "hltid"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "hltid"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://heylinkapi.com/connect/v1/callbacks/advertisers"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 16.9.2022 09.45.00


